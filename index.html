<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CGT Reffing System</title>
  <style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
    background-color: rgb(11, 0, 73);
    color: #ef5842;
  }

  input[type="text"] {
    background-color: #ef5842;
    color: rgb(0, 0, 0);
    border-radius: 5px;
    padding: 10px;
    font-size: 16px;
    border: none;
    width: 100%;
    max-width: 300px;
  }

  button {
    background-color: #ef5842;
    color: rgb(0, 0, 0);
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s;
  }

  button:hover {
    opacity: 0.9;
  }

  .container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
    max-width: 1000px;
    gap: 20px;
    margin-top: 20px;
  }

  .timer {
    background: #167edf;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(255, 255, 255, 0.1);
    text-align: center;
    width: 100%;
    max-width: 320px;
  }

  .time-display {
    font-size: 48px;
    margin: 20px 0;
    background-color: #167edf;
    color: #ef5842;
  }

  .button-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
  }

  .button-group button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background-color: #ef5842;
    color: rgb(0, 0, 0);
  }

  .dropdown select {
    background-color: #000000;
    color: #ef5842;
    padding: 8px;
    font-size: 16px;
    border-radius: 5px;
    border: none;
    width: 100%;
  }

  .dropdown select option {
    background-color: #333;
    color: #ef5842;
  }

  .dropdown select:hover {
    background-color: #444;
  }

  .score-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 25px 0;
  }

  .score-section div {
    text-align: center;
  }

  .score-section .counter {
    font-size: 24px;
    margin: 10px 0;
  }

  .score-section button {
    margin: 10px;
    padding: 15px 30px;
    font-size: 24px;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    background-color: #ef5842;
    color: rgb(0, 0, 0);
    transition: background-color 0.3s;
  }

  .divider {
    display: none; /* Hide on small screens */
    height: 500px;
    width: 5px;
    background: #ef5842;
    margin: 0 20px;
  }

  .label {
    margin-top: 5px;
    font-size: 16px;
    color: #ef5842;
  }

  .penalty-section {
    margin-top: 20px;
  }

  .penalty-log {
    margin-top: 10px;
    background-color: #111;
    padding: 10px;
    border-radius: 5px;
    color: #ef5842;
    max-height: 150px;
    overflow-y: auto;
    font-size: 14px;
    text-align: left;
    width: 100%;
    max-width: 400px;
  }

  /* Penalty Modal Styles */
  #penaltyModal {
    display: none;
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: black;
    color: #ef5842;
    padding: 20px;
    border-radius: 10px;
    z-index: 999;
    width: 90%;
    max-width: 320px;
  }

  #penaltyModal h3 {
    margin-top: 0;
  }

  #penaltyModal label,
  #penaltyModal select,
  #penaltyModal input {
    width: 100%;
    margin-top: 5px;
  }

  #penaltyModal select,
  #penaltyModal input {
    padding: 8px;
    font-size: 16px;
    border-radius: 5px;
    border: none;
    background-color: #222;
    color: #ef5842;
  }

  #penaltyModal button {
    width: 48%;
    margin-top: 15px;
  }

  /* Responsive Design */
  @media (min-width: 768px) {
    .score-section {
      flex-direction: row;
      justify-content: center;
    }

    .divider {
      display: block;
    }
  }
</style>
</head>
<body>
<h1>CGT Reffing System</h1>
  <div id="authBar" style="margin-bottom:12px;"></div>

<div class="dropdown">
  <label for="startingTime">Starting Time:</label>
  <select id="startingTime">
    <option value="5">5 seconds</option>
    <option value="7">7 seconds</option>
    <option value="10" selected>10 seconds</option>
    <option value="15">15 seconds</option>
    <option value="20">20 seconds</option>
  </select>
</div>

<div class="container">
  <div class="timer" id="timer1">
    <input
      type="text"
      id="timer1Name"
      value="Timer 1"
      style="font-size: 16px; text-align: center; width: 80%; margin-bottom: 10px"
    />
    <div class="time-display" id="timer1Display">00:00.00</div>
    <div class="button-group">
      <button onclick="toggleTimer('timer1')" id="timer1StartStop">Start</button>
      <button onclick="resetTimer('timer1')">Reset</button>
    </div>
    <div class="score-section">
      <div>
        <button onclick="incrementScore('timer1')">▲</button>
        <div class="counter" id="timer1Score">0</div>
        <div class="label">Score</div>
        <button onclick="decrementScore('timer1')">▼</button>
        <div class="penalty-section">
          <button onclick="openPenaltyMenu('timer1')">Penalty Menu</button>
          <div class="penalty-log" id="timer1PenaltyLog"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <div class="timer" id="timer2">
    <input
      type="text"
      id="timer2Name"
      value="Timer 2"
      style="font-size: 16px; text-align: center; width: 80%; margin-bottom: 10px"
    />
    <div class="time-display" id="timer2Display">00:00.00</div>
    <div class="button-group">
      <button onclick="toggleTimer('timer2')" id="timer2StartStop">Start</button>
      <button onclick="resetTimer('timer2')">Reset</button>
    </div>
    <div class="score-section">
      <div>
        <button onclick="incrementScore('timer2')">▲</button>
        <div class="counter" id="timer2Score">0</div>
        <div class="label">Score</div>
        <button onclick="decrementScore('timer2')">▼</button>
        <div class="penalty-section">
          <button onclick="openPenaltyMenu('timer2')">Penalty Menu</button>
          <div class="penalty-log" id="timer2PenaltyLog"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<button onclick="resetAllTimers()" style="margin-top: 20px">Reset All Timers</button>

<!-- Penalty Modal -->
<div id="penaltyModal">
  <h3>Select Penalty</h3>
  <label for="penaltyRule">Rule:</label>
  <select id="penaltyRule" onchange="togglePlayerInput()">
    <option value="" disabled selected>Select Rule</option>
    <optgroup label="Game Progression">
      <option value="stalling">Stalling</option>
      <option value="time_wasting">Time Wasting (3x 2-min stops allowed)</option>
      <option value="map_hopping">Map Hopping</option>
    </optgroup>
    <optgroup label="Prohibited Tactics">
      <option value="hiding">Hiding</option>
      <option value="lagging">Lagging (Refuses to leave)</option>
      <option value="dc_flicking">DC Flicking</option>
      <option value="in_game_camera">Using In-Game Camera</option>
      <option value="playspace_abuse">PSA / Crouch Jumping / Rec Room Glitch</option>
      <option value="update_features">Activating Update Features</option>
      <option value="fishlegs">Using Fishlegs</option>
      <option value="illegal_hz">Using Illegal Hz Options</option>
    </optgroup>
    <optgroup label="Subbing Rules">
      <option value="banned_players_unofficial">Using Banned Players in Unofficial Scrim</option>
      <option value="subs_off_team">Using Subs Off Team</option>
    </optgroup>
    <optgroup label="Respecting Ref Rules">
      <option value="toxicity_player">Toxicity Towards Ref (Player)</option>
      <option value="toxicity_team">Toxicity Towards Ref (Team)</option>
      <option value="toxicity_all">Toxicity Towards Ref (Everyone)</option>
      <option value="arguing_ref">Arguing with Ref</option>
    </optgroup>
  </select>
  <div id="playerInput" style="margin-top: 10px; display: none;">
    <label for="playerName">Player Name:</label>
    <input type="text" id="playerName" autocomplete="off" />
  </div>
  <div style="margin-top: 10px; display: flex; justify-content: space-between;">
    <button onclick="submitPenalty()">Submit</button>
    <button onclick="closePenaltyMenu()">Cancel</button>
  </div>
</div>

<div id="officialPanel" style="display:none; margin-top:20px; border-top:2px solid #ef5842; padding-top:12px;">
  <h3>Official Match Controls</h3>
  <button id="startScrimBtn">Start Scrim</button>
  <button id="submitRoundBtn">Submit Round</button>
  <button id="submitResetRoundBtn">Submit Reset Round</button>
  <button id="endScrimBtn">End Scrim</button>
  <div id="officialStatus" style="margin-top:8px; color:#ef5842"></div>
</div>



<script>
  // --- On load: get auth status from backend ---
  async function checkAuth() {
    try {
      const res = await fetch('/auth/status');
      const data = await res.json();
      const bar = document.getElementById('authBar');
      if (data.authenticated) {
        bar.innerHTML = `Logged in as <strong>${data.username}</strong> — <a href="/logout">Logout</a>`;
      } else {
        bar.innerHTML = `<a href="/login">Login with Discord</a>`;
      }

      if (data.eligible) {
        document.getElementById('officialPanel').style.display = 'block';
      }
    } catch (err) {
      console.error('auth check failed', err);
    }
  }

  checkAuth();

  document.getElementById('startScrimBtn').addEventListener('click', () => {
    const team1Name = document.getElementById('timer1Name').value;
    const team2Name = document.getElementById('timer2Name').value;
    
    // Optional: simple validation
    if (!team1Name || !team2Name) {
      alert("Please enter both team names before starting the scrim.");
      return;
    }
  
    const matchData = { team1Name, team2Name };
  
    fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: "Start Scrim", matchData }),
    }).then(async res => {
      const json = await res.json();
      const s = document.getElementById('officialStatus');
      if (res.ok) {
        s.textContent = `Scrim started: ${team1Name} vs ${team2Name}`;
      } else {
        s.textContent = `Submit failed: ${json.error || 'unknown'}`;
      }
    });
  });

  let currentRound = 0;

  document.getElementById('submitRoundBtn').addEventListener('click', () => {
    currentRound += 1;  // increment round number

    const data = {
      team1Name: document.getElementById('timer1Name').value,
      team1Score: document.getElementById('timer1Score').textContent,
      team1Time: document.getElementById('timer1Display').textContent,
      team2Name: document.getElementById('timer2Name').value,
      team2Score: document.getElementById('timer2Score').textContent,
      team2Time: document.getElementById('timer2Display').textContent,
      round: currentRound
    };

    fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: "Submit Round", matchData: data }),
    })
    .then(async res => {
      const json = await res.json();
      const s = document.getElementById('officialStatus');
      if (res.ok) {
        s.textContent = `Round ${currentRound} submitted successfully`;
      } else {
        s.textContent = `Submit failed: ${json.error || 'unknown'}`;
        currentRound--; // revert round count if failed
      }
    })
    .catch(err => {
      console.error('Submit Round error:', err);
    });
  });

  document.getElementById('endScrimBtn').addEventListener('click', () => {
    const team1Name = document.getElementById('timer1Name').value;
    const team2Name = document.getElementById('timer2Name').value;
    const team1Score = parseInt(document.getElementById('timer1Score').textContent, 10) || 0;
    const team2Score = parseInt(document.getElementById('timer2Score').textContent, 10) || 0;
    const team1Time = document.getElementById('timer1Display').textContent;
    const team2Time = document.getElementById('timer2Display').textContent;

    if (!team1Name || !team2Name) {
      alert("Please enter both team names.");
      return;
    }

    // Determine winner message
    let winnerMessage;
    if (team1Score > team2Score) {
      winnerMessage = `# 🎉 **${team1Name}** Wins with ${team1Score} points!`;
    } else if (team2Score > team1Score) {
      winnerMessage = `# 🎉 **${team2Name}** Wins with ${team2Score} points!`;
    } else {
      winnerMessage = "It's a tie!";
    }

    const matchData = {
      team1Name,
      team1Score,
      team1Time,
      team2Name,
      team2Score,
      team2Time,
      winnerMessage,  // send this extra info to backend
    };

    fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: "End Scrim", matchData }),
    }).then(async res => {
      const json = await res.json();
      const s = document.getElementById('officialStatus');
      if (res.ok) {
        s.textContent = `Scrim ended. ${winnerMessage}`;
        currentRound = 0;
      } else {
        s.textContent = `Submit failed: ${json.error || 'unknown'}`;
      }
    });
  });

  document.getElementById('submitResetRoundBtn').addEventListener('click', () => {
    const team1Name = document.getElementById('timer1Name').value;
    const team2Name = document.getElementById('timer2Name').value;
    const team1Score = document.getElementById('timer1Score').textContent;
    const team2Score = document.getElementById('timer2Score').textContent;
    const team1Time = document.getElementById('timer1Display').textContent;
    const team2Time = document.getElementById('timer2Display').textContent;

    const matchData = {
      team1Name,
      team1Score,
      team1Time,
      team2Name,
      team2Score,
      team2Time,
    };

    fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: "Submit Reset Round", matchData }),
    }).then(async res => {
      const json = await res.json();
      const s = document.getElementById('officialStatus');
      if (res.ok) {
        s.textContent = 'Round reset submitted successfully';
      } else {
        s.textContent = `Submit failed: ${json.error || 'unknown'}`;
      }
    });
  });


  let timers = {
    timer1: { startTime: null, elapsedTime: 0, running: false, score: 0 },
    timer2: { startTime: null, elapsedTime: 0, running: false, score: 0 },
  };

  const formatTime = (time) => {
    const absTime = Math.abs(time);
    const minutes = Math.floor(absTime / 60);
    const seconds = Math.floor(absTime % 60);
    const milliseconds = Math.floor((absTime - Math.floor(absTime)) * 100);
    const sign = time < 0 ? "-" : "";
    return `${sign}${String(minutes).padStart(2, "0")}:${String(seconds).padStart(
      2,
      "0"
    )}.${String(milliseconds).padStart(2, "0")}`;
  };

  const updateDisplay = (timerId) => {
    const timer = timers[timerId];
    if (timer.running) {
      timer.elapsedTime = (Date.now() - timer.startTime) / 1000;
      document.getElementById(`${timerId}Display`).textContent = formatTime(
        timer.elapsedTime
      );
      requestAnimationFrame(() => updateDisplay(timerId));
    } else {
      document.getElementById(`${timerId}Display`).textContent = formatTime(
        timer.elapsedTime
      );
    }
  };

  const toggleTimer = (timerId) => {
    const timer = timers[timerId];
    if (timer.running) {
      timer.running = false;
      document.getElementById(`${timerId}StartStop`).textContent = "Start";
    } else {
      timer.running = true;
      timer.startTime = Date.now() - timer.elapsedTime * 1000;
      document.getElementById(`${timerId}StartStop`).textContent = "Stop";
      updateDisplay(timerId);
    }
  };

  const resetTimer = (timerId) => {
    const startingTime = parseInt(document.getElementById("startingTime").value, 10);
    const timer = timers[timerId];
    timer.elapsedTime = -startingTime;
    timer.running = false;
    document.getElementById(`${timerId}StartStop`).textContent = "Start";
    document.getElementById(`${timerId}Display`).textContent = formatTime(
      timer.elapsedTime
    );
  };

  const resetAllTimers = () => {
    resetTimer("timer1");
    resetTimer("timer2");
  };

  // Initialize timers with starting time
  resetAllTimers();

  const incrementScore = (timerId) => {
    timers[timerId].score++;
    document.getElementById(`${timerId}Score`).textContent = timers[timerId].score;
  };

  const decrementScore = (timerId) => {
    if (timers[timerId].score > 0) {
      timers[timerId].score--;
      document.getElementById(`${timerId}Score`).textContent = timers[timerId].score;
    }
  };

  // Penalty System Logic
  let activeTimerForPenalty = null;

  // Offense tracking: team offenses and player offenses separately
  const offenseCounts = {
    team: {}, // e.g., { timer1: { stalling: 2, time_wasting: 1 } }
    player: {}, // e.g., { "PlayerName": { stalling: 1 } }
  };

  // Penalty rules & punishments escalating per offense #
  const penaltyRules = {
    stalling: [
      "Warning to team",
      "Player sits out round (chosen by punished team)",
      "Forfeit of point",
      "Forfeit of match",
      "Stacking 1 month bans (player-specific)",
    ],
    time_wasting: [
      "Allowed up to 3 stops",
      "Skip to 2nd offense of stalling rule",
    ],
    map_hopping: [
      "Forfeit round",
      "Forfeit match & 1 month ban (player)",
      "Stacking 1 month bans",
    ],
    hiding: ["Warning", "Forfeit round", "Forfeit match", "Stacking 1 month bans"],
    lagging: [
      "Forfeit match (if refuses to leave after 2 mins)",
    ],
    dc_flicking: ["Warning", "Forfeit round", "Forfeit match"],
    in_game_camera: ["Forfeit round and 1 month ban"],
    playspace_abuse: ["3 month ban", "Perm ban"],
    update_features: [
      "Warning",
      "Forfeit round",
      "Forfeit match",
      "Stacking 1 month bans",
    ],
    fishlegs: ["Warning", "Forfeit round", "Forfeit match", "Stacking 1 month bans"],
    illegal_hz: ["3 month ban", "Perm ban"],
    banned_players_unofficial: ["Strong warning", "Disbandment"],
    subs_off_team: ["Instant forfeit and disbandment"],
    toxicity_player: ["Warning", "Sit out round", "Ejection from match"],
    toxicity_team: [
      "Warning",
      "30 sec holding of tagger + warning",
      "Point deduction + final warning",
      "Match forfeit",
    ],
    toxicity_all: [
      "Warning to both teams",
      "Second warning",
      "Rescheduling of scrim with different ref",
    ],
    arguing_ref: ["Let argue, but if disrespectful → punish as toxicity"],
  };

  // Rules that require player name input
  const playerSpecificRules = [
    "map_hopping",
    "hiding",
    "dc_flicking",
    "in_game_camera",
    "playspace_abuse",
    "illegal_hz",
    "toxicity_player",
  ];

  // Show/hide player input box in penalty modal
  function togglePlayerInput() {
    const rule = document.getElementById("penaltyRule").value;
    if (playerSpecificRules.includes(rule)) {
      document.getElementById("playerInput").style.display = "block";
    } else {
      document.getElementById("playerInput").style.display = "none";
      document.getElementById("playerName").value = "";
    }
  }

  // Open penalty modal for given timer
  function openPenaltyMenu(timerId) {
    activeTimerForPenalty = timerId;
    document.getElementById("penaltyModal").style.display = "block";
    document.getElementById("penaltyRule").selectedIndex = 0;
    togglePlayerInput();
    document.getElementById("playerName").value = "";
  }

  // Close penalty modal
  function closePenaltyMenu() {
    document.getElementById("penaltyModal").style.display = "none";
    activeTimerForPenalty = null;
  }

  // Submit penalty and update logs & offense counts
  function submitPenalty() {
    const rule = document.getElementById("penaltyRule").value;
    const playerName = document.getElementById("playerName").value.trim();
    if (playerSpecificRules.includes(rule) && !playerName) {
      alert("Please enter the player name for this penalty.");
      return;
    }

    if (!offenseCounts.team[activeTimerForPenalty]) {
      offenseCounts.team[activeTimerForPenalty] = {};
    }
    if (!offenseCounts.team[activeTimerForPenalty][rule]) {
      offenseCounts.team[activeTimerForPenalty][rule] = 0;
    }
    if (playerName && !offenseCounts.player[playerName]) {
      offenseCounts.player[playerName] = {};
    }
    if (playerName && !offenseCounts.player[playerName][rule]) {
      offenseCounts.player[playerName][rule] = 0;
    }

    let offenseNum;
    if (playerSpecificRules.includes(rule)) {
      offenseCounts.player[playerName][rule]++;
      offenseNum = offenseCounts.player[playerName][rule];
    } else {
      offenseCounts.team[activeTimerForPenalty][rule]++;
      offenseNum = offenseCounts.team[activeTimerForPenalty][rule];
    }

    const punishments = penaltyRules[rule] || ["No punishment defined"];
    const appliedPunishment =
      punishments[Math.min(offenseNum - 1, punishments.length - 1)];

    // Log the penalty with timestamp
    const logEl = document.getElementById(`${activeTimerForPenalty}PenaltyLog`);
    const timestamp = new Date().toLocaleTimeString();
    const logMessage = playerName
      ? `[${timestamp}] Player ${playerName} offense #${offenseNum} for ${rule.replace(
          /_/g,
          " "
        )}: ${appliedPunishment}`
      : `[${timestamp}] Team offense #${offenseNum} for ${rule.replace(
          /_/g,
          " "
        )}: ${appliedPunishment}`;

    logEl.innerHTML += `<div>${logMessage}</div>`;
    logEl.scrollTop = logEl.scrollHeight;

    // You can add code here to apply any real effects:
    // For example:
    // - Penalize score or time based on offense
    // - Mark player as sitting out round (you'd need your own data structure)
    // - Trigger other UI updates or alerts
    // Currently just logging.

    closePenaltyMenu();
  }
</script>
</body>
</html>
